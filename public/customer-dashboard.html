<!DOCTYPE html>
<html>
<head>
    <title>Customer Dashboard - Booking System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { 
            background: #2ecc71; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 30px;
            position: relative;
        }
        h1 { margin-bottom: 10px; display: inline-block; }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .logout-btn:hover {
            background: #c0392b;
        }
        .status { display: flex; gap: 20px; margin-bottom: 30px; }
        .status-card { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; }
        .tab.active { background: #2ecc71; color: white; }
        .content { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .content.active { display: block; }
        .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .slot-card { border: 1px solid #ddd; padding: 20px; border-radius: 10px; }
        .slot-card h3 { margin-bottom: 10px; color: #2c3e50; }
        .slot-details { margin: 10px 0; }
        .book-btn { 
            width: 100%; 
            padding: 10px; 
            background: #2ecc71; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-top: 10px; 
            font-weight: bold;
        }
        .book-btn:hover { background: #27ae60; }
        .book-btn:disabled { background: #95a5a6; cursor: not-allowed; }
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        .cancel-btn { 
            background: #e74c3c;
            color: white;
        }
        .cancel-btn:hover { background: #c0392b; }
        .reschedule-btn { 
            background: #3498db;
            color: white;
        }
        .reschedule-btn:hover { background: #2980b9; }
        .action-btn:disabled { 
            background: #95a5a6; 
            cursor: not-allowed; 
        }
        .success { color: green; }
        .error { color: red; }
        .past-booking { opacity: 0.7; background: #f8f9fa; }
        .upcoming-booking { background: #e8f5e9; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f2f2f2; }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .close-btn:hover {
            color: #000;
        }
        .modal-slot {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .modal-slot:hover {
            background: #f0f8ff;
            border-color: #3498db;
        }
        .modal-slot.selected {
            background: #e3f2fd;
            border-color: #3498db;
            box-shadow: 0 0 0 2px #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üë§ Customer Dashboard</h1>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            <p id="customer-info">Welcome, Customer</p>
        </header>

        <div class="status">
            <div class="status-card">
                <h3>My Bookings</h3>
                <p id="booking-count" class="loading">Loading...</p>
            </div>
            <div class="status-card">
                <h3>Available Services</h3>
                <p id="service-count" class="loading">Loading...</p>
            </div>
            <div class="status-card">
                <h3>Upcoming</h3>
                <p id="upcoming-count" class="loading">Loading...</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('available')">üîç Find & Book</button>
            <button class="tab" onclick="switchTab('my-bookings')">üìã My Bookings</button>
            <button class="tab" onclick="switchTab('profile')">üë§ Profile</button>
        </div>

        <!-- AVAILABLE SLOTS TAB -->
        <div id="available" class="content active">
            <h2>Available Time Slots</h2>
            <div id="available-slots" class="slots-grid">Loading available slots...</div>
        </div>

        <!-- MY BOOKINGS TAB -->
        <div id="my-bookings" class="content">
            <h2>My Bookings</h2>
            <div id="bookings-list">Loading your bookings...</div>
        </div>

        <!-- PROFILE TAB -->
        <div id="profile" class="content">
            <h2>My Profile</h2>
            <div id="profile-info">Loading profile...</div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px;">
            <h2>System Status</h2>
            <pre id="output" style="background: #f5f5f5; padding: 15px; border-radius: 5px; max-height: 200px; overflow: auto;">
Click tabs to see actions...
            </pre>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div id="reschedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ Reschedule Appointment</h2>
                <span class="close-btn" onclick="closeRescheduleModal()">&times;</span>
            </div>
            <p id="reschedule-current">Current: Loading...</p>
            <h3>Select New Time Slot:</h3>
            <div id="reschedule-slots">Loading available slots...</div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="action-btn cancel-btn" onclick="closeRescheduleModal()">Cancel</button>
                <button class="action-btn reschedule-btn" onclick="confirmReschedule()" id="confirm-reschedule-btn" disabled>Confirm Reschedule</button>
            </div>
        </div>
    </div>

    <script>
        let customerToken = '';
        let customerId = '';
        let currentBookingToReschedule = null;
        let selectedNewSlotId = null;
        let availableSlotsForReschedule = [];

        // Check if already logged in
        window.onload = function() {
            const savedToken = localStorage.getItem('customerToken');
            if (savedToken) {
                customerToken = savedToken;
                loadCustomerData();
            } else {
                // Try to auto-login with existing customer
                loginCustomer();
            }
        };

        async function loginCustomer() {
            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: 'customer@test.com',
                        password: 'test123'
                    })
                });
                
                const data = await response.json();
                showOutput(data);
                
                if (data.success) {
                    customerToken = data.token;
                    customerId = data.user.id;
                    localStorage.setItem('customerToken', customerToken);
                    document.getElementById('customer-info').innerHTML = 
                        `Welcome, <strong>${data.user.name}</strong> | ${data.user.email}`;
                    loadCustomerData();
                }
            } catch (error) {
                showOutput({error: error.message});
            }
        }

        async function loadCustomerData() {
            try {
                // Load available slots
                const slotsRes = await fetch('http://localhost:3000/api/bookings/available');
                const slots = await slotsRes.json();
                
                if (slots.success) {
                    document.getElementById('service-count').innerHTML = 
                        `<span class="success">${slots.count} slots available</span>`;
                    displayAvailableSlots(slots.slots);
                }

                // Load customer's bookings
                const bookingsRes = await fetch('http://localhost:3000/api/bookings/my-bookings', {
                    headers: {'Authorization': `Bearer ${customerToken}`}
                });
                const bookings = await bookingsRes.json();
                
                if (bookings.success) {
                    document.getElementById('booking-count').innerHTML = 
                        `<span class="success">${bookings.count} bookings</span>`;
                    displayBookings(bookings.bookings);
                }

            } catch (error) {
                showOutput({error: error.message});
            }
        }

        function displayAvailableSlots(slots) {
            const container = document.getElementById('available-slots');
            
            if (!slots || slots.length === 0) {
                container.innerHTML = '<p>No available slots at the moment. Check back later!</p>';
                return;
            }

            container.innerHTML = '';
            
            slots.forEach(slot => {
                const card = document.createElement('div');
                card.className = 'slot-card';
                card.innerHTML = `
                    <h3>${slot.service_name}</h3>
                    <div class="slot-details">
                        <p><strong>Provider:</strong> ${slot.provider_name}</p>
                        <p><strong>Date:</strong> ${new Date(slot.date).toLocaleDateString()}</p>
                        <p><strong>Time:</strong> ${slot.starttime} - ${slot.endtime}</p>
                        <p><strong>Price:</strong> $${slot.price}</p>
                        <p><strong>Description:</strong> ${slot.description}</p>
                    </div>
                    <button class="book-btn" onclick="bookSlot(${slot.availabilityid})">
                        üìÖ Book This Slot
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function displayBookings(bookings) {
            const container = document.getElementById('bookings-list');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = '<p>You have no bookings yet.</p>';
                return;
            }

            // Separate upcoming and past bookings
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcoming = [];
            const past = [];
            
            bookings.forEach(booking => {
                const bookingDate = new Date(booking.booking_date);
                if (bookingDate >= today) {
                    upcoming.push(booking);
                } else {
                    past.push(booking);
                }
            });

            let html = '';
            
            // Upcoming bookings with action buttons
            if (upcoming.length > 0) {
                html += `<h3>‚è∞ Upcoming Appointments (${upcoming.length})</h3>`;
                html += '<table>';
                html += '<tr><th>Service</th><th>Date</th><th>Time</th><th>Provider</th><th>Status</th><th>Actions</th></tr>';
                
                upcoming.forEach(booking => {
                    const bookingDate = new Date(booking.booking_date);
                    const canModify = bookingDate > today;
                    
                    html += `
                        <tr class="upcoming-booking">
                            <td><strong>${booking.service_name}</strong><br><small>$${booking.price}</small></td>
                            <td>${bookingDate.toLocaleDateString()}</td>
                            <td>${booking.starttime} - ${booking.endtime}</td>
                            <td>${booking.provider_name}</td>
                            <td><span class="success">${booking.status}</span></td>
                            <td>
                                ${canModify ? 
                                    `<div style="display: flex; gap: 5px;">
                                        <button class="action-btn reschedule-btn" onclick="openRescheduleModal(${booking.bookingid}, '${booking.service_name}', '${bookingDate.toLocaleDateString()}', '${booking.starttime}-${booking.endtime}')">
                                            Reschedule
                                        </button>
                                        <button class="action-btn cancel-btn" onclick="cancelBooking(${booking.bookingid})">
                                            Cancel
                                        </button>
                                    </div>` : 
                                    '<small>Cannot modify past booking</small>'
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                document.getElementById('upcoming-count').innerHTML = 
                    `<span class="success">${upcoming.length} upcoming</span>`;
            } else {
                html += '<p>No upcoming appointments.</p>';
                document.getElementById('upcoming-count').innerHTML = `<span class="success">0 upcoming</span>`;
            }
            
            // Past bookings (no action buttons)
            if (past.length > 0) {
                html += `<h3 style="margin-top: 30px;">üìú Past Appointments (${past.length})</h3>`;
                html += '<table>';
                html += '<tr><th>Service</th><th>Date</th><th>Time</th><th>Provider</th><th>Status</th></tr>';
                
                past.forEach(booking => {
                    html += `
                        <tr class="past-booking">
                            <td><strong>${booking.service_name}</strong><br><small>$${booking.price}</small></td>
                            <td>${new Date(booking.booking_date).toLocaleDateString()}</td>
                            <td>${booking.starttime} - ${booking.endtime}</td>
                            <td>${booking.provider_name}</td>
                            <td><span class="success">${booking.status}</span></td>
                        </tr>
                    `;
                });
                
                html += '</table>';
            }
            
            container.innerHTML = html;
        }

        async function bookSlot(availabilityId) {
            if (!customerToken) {
                alert('Please login first!');
                return;
            }
            
            if (!confirm('Are you sure you want to book this slot?')) {
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${customerToken}`
                    },
                    body: JSON.stringify({ availability_id: availabilityId })
                });
                
                const result = await response.json();
                showOutput(result);
                
                if (result.success) {
                    alert('‚úÖ Booking successful!');
                    // Refresh data
                    loadCustomerData();
                } else {
                    alert(`‚ùå Booking failed: ${result.message}`);
                }
            } catch (error) {
                showOutput({error: error.message});
                alert('Booking failed. Please try again.');
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?\n\nThis will make the time slot available for others.')) {
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/bookings/cancel', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${customerToken}`
                    },
                    body: JSON.stringify({ booking_id: bookingId })
                });
                
                const result = await response.json();
                showOutput(result);
                
                if (result.success) {
                    alert('‚úÖ Booking cancelled successfully!');
                    // Refresh data
                    loadCustomerData();
                } else {
                    alert(`‚ùå Cancellation failed: ${result.message}`);
                }
            } catch (error) {
                showOutput({error: error.message});
                alert('Cancellation failed. Please try again.');
            }
        }

        // Reschedule functions
        async function openRescheduleModal(bookingId, serviceName, currentDate, currentTime) {
            currentBookingToReschedule = bookingId;
            
            // Update modal header
            document.getElementById('reschedule-current').innerHTML = 
                `Current: <strong>${serviceName}</strong> on ${currentDate} at ${currentTime}`;
            
            // Load available slots for rescheduling
            try {
                const response = await fetch('http://localhost:3000/api/bookings/available');
                const data = await response.json();
                
                if (data.success) {
                    availableSlotsForReschedule = data.slots;
                    displayRescheduleSlots(data.slots);
                    document.getElementById('reschedule-modal').style.display = 'block';
                }
            } catch (error) {
                alert('Error loading available slots: ' + error.message);
            }
        }

        function displayRescheduleSlots(slots) {
            const container = document.getElementById('reschedule-slots');
            selectedNewSlotId = null;
            
            if (!slots || slots.length === 0) {
                container.innerHTML = '<p>No other time slots available for rescheduling.</p>';
                document.getElementById('confirm-reschedule-btn').disabled = true;
                return;
            }

            let html = '';
            slots.forEach(slot => {
                html += `
                    <div class="modal-slot" onclick="selectRescheduleSlot(${slot.availabilityid})" id="slot-${slot.availabilityid}">
                        <h4>${slot.service_name}</h4>
                        <p><strong>Date:</strong> ${new Date(slot.date).toLocaleDateString()}</p>
                        <p><strong>Time:</strong> ${slot.starttime} - ${slot.endtime}</p>
                        <p><strong>Provider:</strong> ${slot.provider_name}</p>
                        <p><strong>Price:</strong> $${slot.price}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('confirm-reschedule-btn').disabled = true;
        }

        function selectRescheduleSlot(slotId) {
            selectedNewSlotId = slotId;
            
            // Remove selected class from all slots
            document.querySelectorAll('.modal-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Add selected class to clicked slot
            document.getElementById(`slot-${slotId}`).classList.add('selected');
            document.getElementById('confirm-reschedule-btn').disabled = false;
        }

        function closeRescheduleModal() {
            document.getElementById('reschedule-modal').style.display = 'none';
            currentBookingToReschedule = null;
            selectedNewSlotId = null;
        }

        async function confirmReschedule() {
            if (!currentBookingToReschedule || !selectedNewSlotId) {
                alert('Please select a new time slot');
                return;
            }
            
            if (!confirm('Are you sure you want to reschedule to this new time slot?')) {
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/bookings/reschedule', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${customerToken}`
                    },
                    body: JSON.stringify({
                        booking_id: currentBookingToReschedule,
                        new_availability_id: selectedNewSlotId
                    })
                });
                
                const result = await response.json();
                showOutput(result);
                
                if (result.success) {
                    alert('‚úÖ Booking rescheduled successfully!');
                    closeRescheduleModal();
                    // Refresh data
                    loadCustomerData();
                } else {
                    alert(`‚ùå Reschedule failed: ${result.message}`);
                }
            } catch (error) {
                showOutput({error: error.message});
                alert('Reschedule failed. Please try again.');
            }
        }

        function logout() {
            localStorage.removeItem('customerToken');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activate selected tab
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showOutput(data) {
            document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        }
    </script>
</body>
</html>
